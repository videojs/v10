---
import { getEntry } from 'astro:content';
import { kebabCase } from 'es-toolkit/string';
import ContentWidth from '@/components/frames/ContentWidth.astro';
import H2 from '@/components/typography/H2Markdown.astro';
import H3 from '@/components/typography/H3Markdown.astro';
import H4 from '@/components/typography/H4Markdown.astro';
import MarkdownCode from '@/components/typography/MarkdownCode.astro';
import P from '@/components/typography/P.astro';
import type { ComponentApiReference } from '@/types/api-reference';
import { isValidFramework } from '@/types/docs';
import { createApiReferenceModel } from '@/utils/apiReferenceModel';
import FrameworkCase from '../FrameworkCase.astro';
import ApiDataAttrsTable from './ApiDataAttrsTable.astro';
import ApiPropsTable from './ApiPropsTable.astro';
import ApiStateTable from './ApiStateTable.astro';
import InlineMarkdown from './InlineMarkdown.astro';

interface Props {
  component: string;
}

const { component } = Astro.props;
const { framework } = Astro.params;
if (!framework || !isValidFramework(framework)) {
  throw new Error(`Invalid or missing framework param.`);
}

const entry = await getEntry('apiReference', kebabCase(component));
const apiRef: ComponentApiReference | null = entry?.data ?? null;
if (!apiRef) return;

const apiReferenceModel = createApiReferenceModel(component, apiRef);
if (!apiReferenceModel) return;

const singlePropsSection = !apiReferenceModel.hasParts
  ? apiReferenceModel.sections.find((section) => section.key === 'props')
  : null;
const singleStateSection = !apiReferenceModel.hasParts
  ? apiReferenceModel.sections.find((section) => section.key === 'state')
  : null;
const singleDataAttributesSection = !apiReferenceModel.hasParts
  ? apiReferenceModel.sections.find((section) => section.key === 'dataAttributes')
  : null;
---

<ContentWidth>
  <H2 id={apiReferenceModel.heading.id}>{apiReferenceModel.heading.text}</H2>

  {apiReferenceModel.hasParts ? (
    apiReferenceModel.parts.map((part) => {
      const partPropsSection = part.sections.find((section) => section.key === 'props');
      const partStateSection = part.sections.find((section) => section.key === 'state');
      const partDataAttributesSection = part.sections.find((section) => section.key === 'dataAttributes');

      return (
        <>
          <H3 id={part.id}>
            <FrameworkCase frameworks={["react"]}>{part.labelByFramework.react}</FrameworkCase>
            <FrameworkCase frameworks={["html"]}>{part.labelByFramework.html}</FrameworkCase>
          </H3>

          {part.description && (
            <P><InlineMarkdown content={part.description} /></P>
          )}

          {partPropsSection && (
            <>
              <H4 id={partPropsSection.id}>{partPropsSection.title}</H4>
              <ApiPropsTable props={part.data.props} componentName={part.componentName} />
            </>
          )}

          {partStateSection && (
            <>
              <H4 id={partStateSection.id}>{partStateSection.title}</H4>
              <P>
                <FrameworkCase frameworks={["react"]}>
                  State is accessible via the{" "}
                  <MarkdownCode>render</MarkdownCode>,{" "}
                  <MarkdownCode>className</MarkdownCode>, and{" "}
                  <MarkdownCode>style</MarkdownCode> props.
                </FrameworkCase>
                <FrameworkCase frameworks={["html"]}>
                  State is reflected as data attributes for CSS styling.
                </FrameworkCase>
              </P>
              <ApiStateTable state={part.data.state} componentName={part.componentName} />
            </>
          )}

          {partDataAttributesSection && (
            <>
              <H4 id={partDataAttributesSection.id}>{partDataAttributesSection.title}</H4>
              <ApiDataAttrsTable dataAttributes={part.data.dataAttributes} />
            </>
          )}
        </>
      );
    })
  ) : (
    <>
      {singlePropsSection && (
        <>
          <H3 id={singlePropsSection.id}>{singlePropsSection.title}</H3>
          <ApiPropsTable props={apiReferenceModel.data.props} componentName={component} />
        </>
      )}

      {singleStateSection && (
        <>
          <H3 id={singleStateSection.id}>{singleStateSection.title}</H3>
          <P>
            <FrameworkCase frameworks={["react"]}>
              State is accessible via the{" "}
              <MarkdownCode>render</MarkdownCode>,{" "}
              <MarkdownCode>className</MarkdownCode>, and{" "}
              <MarkdownCode>style</MarkdownCode> props.
            </FrameworkCase>
            <FrameworkCase frameworks={["html"]}>
              State is reflected as data attributes for CSS styling.
            </FrameworkCase>
          </P>
          <ApiStateTable state={apiReferenceModel.data.state} componentName={component} />
        </>
      )}

      {singleDataAttributesSection && (
        <>
          <H3 id={singleDataAttributesSection.id}>{singleDataAttributesSection.title}</H3>
          <ApiDataAttrsTable dataAttributes={apiReferenceModel.data.dataAttributes} />
        </>
      )}
    </>
  )}
</ContentWidth>
