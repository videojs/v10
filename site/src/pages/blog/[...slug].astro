---

import type { CollectionEntry } from 'astro:content';
import { getCollection, getEntries, render } from 'astro:content';
import FormattedDate from '@/components/FormattedDate.astro';
import JsonLd from '@/components/JsonLd.astro';
import defaultMarkdownComponents from '@/components/typography/defaultMarkdownComponents';
import Blog from '@/layouts/Blog.astro';
import { createBlogPostingSchema } from '@/utils/jsonLd/schemas';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts
    .filter((post) => !post.data.devOnly || import.meta.env.DEV)
    .map((post) => ({
      params: { slug: post.id },
      props: post,
    }));
}
type Props = CollectionEntry<'blog'>;

const post = Astro.props;
const { Content, remarkPluginFrontmatter } = await render(post);
const authors = await getEntries(post.data.authors);

// Build JSON-LD schema for BlogPosting
const pageUrl = new URL(Astro.url.pathname, Astro.site).toString();
const jsonLdSchema = createBlogPostingSchema({
  title: post.data.title,
  description: post.data.description,
  url: pageUrl,
  pubDate: post.data.pubDate,
  updatedDate: post.data.updatedDate,
  readingTime: remarkPluginFrontmatter.readingTimeMinutes,
  authors,
  siteUrl: Astro.site!.toString(),
});
---

<Blog title={[post.data.title, 'Blog']} description={post.data.description} canonical={post.data.canonical}>
  <JsonLd slot="head" schema={jsonLdSchema} />
  <article
    class="@container"
    data-pagefind-body
    data-llms-content
    data-llms-description={post.data.description}
    data-llms-sort={post.data.pubDate.toISOString()}
    data-site="blog"
    data-pagefind-filter="site[data-site]"
  >
    <header class="border-b border-light-40 dark:border-dark-80 max-w-3xl mx-auto pb-10 mb-10 relative">
      <div class="font-medium md:text-lg text-dark-40 dark:text-light-40 flex gap-4 mb-1">
        <FormattedDate data-pagefind-sort={`date:${post.data.pubDate.toISOString()}`} date={post.data.pubDate} />
        <span>&bull;</span>
        <span data-pagefind-ignore data-llms-ignore>{remarkPluginFrontmatter.minutesRead}</span>
      </div>
      <h1 class="text-h4 md:text-h2 mb-2">{post.data.title}</h1>
      <div class="font-medium md:text-lg text-dark-40 dark:text-light-40">
        By {
          new Intl.ListFormat('en', { style: 'long', type: 'conjunction' })
            .formatToParts(authors.map((author) => author.data.name))
            .map((part) =>
              part.type === 'element' ? (
                // inline-block removes the whitespace that prettier+astro adds around the text
                <a
                  href={`/blog/authors/${authors.find((a) => a.data.name === part.value)?.id}`}
                  class="intent:underline inline-block"
                  data-pagefind-meta="author"
                >
                  {part.value}
                </a>
              ) : (
                <span class="inline-block" data-pagefind-meta="author">
                  {part.value}
                </span>
              ),
            )
        }
      </div>
    </header>
    <Content components={{ ...defaultMarkdownComponents }} />
  </article>
</Blog>
